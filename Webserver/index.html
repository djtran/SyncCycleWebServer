<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .container {
    width: 80%;
    margin: 15px auto;
  }

  html, body, .container-fluid, .col-md-3, .row {
    height:100%;
  }

  .buffer {
    background-color: #EEEEEE;
  }

  #mid-strip {
    background-color: #00a3e0;
  }


  h6, h2, h3, h4 {
    font-family: 'Titillium Web', sans-serif;
    text-align: left;
  }

  #main-row > div, #buffer{
    height:100%;
  }

  .extra-stats {
    margin-top: -320px;
    height: 20%;
  }

  .button-row {
    background-color: #1d1160
    height: 100%;
  }

  button {
    font-family: 'Open Sans', sans-serif;
  }

  body, #sidebar {
    background-color: #1d1160;
  }

  .main-display {
    background-color: #00c1d5;
  }

  button {
    margin-left: 30px;
  }

  .axis path {
    fill: none;
    stroke: #777;
    shape-rendering: crispEdges;
  }

  .axis text {
    font-family: 'Open Sans', sans-serif;
    font-size: 13px;
  }

  img {
    padding-bottom: 10px;
    padding-top: 10px;
    max-width: 100%;
    height: auto;
    background-color: #1d1160;
  }

</style>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
  <script src="http://d3js.org/d3.v3.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
  <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="http://getbootstrap.com/examples/justified-nav/justified-nav.css" rel="stylesheet"> -->
</head>
<body>


<div class="container-fluid">

  <div class="row" id="main-row">
    <div class="col-md-3 col-lg-3 no-float" id="sidebar">
      <img src="http://naturalenergywyre.co.uk/wp-content/uploads/2015/02/1000px-National_Grid.svg_.png"></img>
      <div class="button-row row">

        <button type="button" class="myButton">Refresh Data</button>
      </div>
    </div>
    <div class="col-md-1 col-lg-1 buffer" style="height: 100%;">
      <div class="row">
        <div class="col-md-6" id="mid-strip"></div>
        <div class="col-md-6"></div>
      </div>
    </div>
    <div class="col-md-7 col-lg-7 buffer" style="height: 100%;">
      <div class="title row" style="backgroundColor: #00c1d5">
      </div>
      <div class="dump row" style="margin-top: -650px;">
        <div class="panel">
        <svg id="chart" width="1000" height="380"></svg>
        </div>
      </div>


      <div class="row extra-stats panel panel-content" style="height: 200px">

        <div class="col-md-7 col-md-offset-1">
          <h3 id="totalDistance"><strong></strong></h2>
          <h3 id="averageSpeed"><strong></strong></h2>
          <h3 id="totalDuration"><strong></strong></h2>
          <h3 id="emissionsPrevented"><strong></strong></h2>
        </div>
        <div class="col-md-4">
          <h3 class="totalDistance"></h3>
          <h3 class="averageSpeed"></h3>
          <h3 class="totalDuration"></h3>
          <h3 class="emissionsPrevented"></h3>
        </div>
	     </div>
       <div class="row extra-stats" style="margin-top:-600px">
         <div class="col-md-3">


       </div>
      </div>



    </div>
    <div class="col-md-1 col-lg-1 buffer" style="height: 100%;">
    </div>
  </div>


</div>

<script>

function plotSVG(data) {

  console.log(data);

  var vis = d3.select("#chart");
  var WIDTH = 700;
  var HEIGHT = 350;
  var MARGINS = {
        top: 20,
        right: 20,
        bottom: 20,
        left: 50
  };

  var xScale = d3.scale.linear().range([MARGINS.left, WIDTH - MARGINS.right]).domain([0,5]);
  var yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0,10]);

  var xAxis = d3.svg.axis().scale(xScale);
  var yAxis = d3.svg.axis()
    .scale(yScale)
    .orient("left");

  vis.append("text")
    .attr("transform",
          "translate(" + (WIDTH/2) + " ," +
                         (HEIGHT + MARGINS.top + 5) + ")")
    .style("text-anchor", "middle")
    .text("TIME (min)");

  // text label for the y axis
  vis.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", 0 - (HEIGHT / 2))
        .attr("y", MARGINS.left - 50)
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("SPEED (mph)");

  vis.append("svg:g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
    .style("text-anchor", "end")
    .text("Number of Applicatons")
    .call(xAxis);

  vis.append("svg:g")
    .attr("class", "axis")
    .attr("transform", "translate(" + MARGINS.left + ",0)")
    .call(yAxis);

  var lineGen = d3.svg.line()
    .x(function(d) {
      return xScale(d.time);
    })
    .y(function(d) {
      return yScale(d.value);
    })
    .interpolate("basis");

  vis.append('svg:path')
    .attr('d', lineGen(data))
    .attr('stroke', 'blue')
    .attr('stroke-width', 2)
    .attr('fill', 'none');

}

var dump = [];
var times = [];
var values = [];

var max = 0;

$('.myButton').on("click", function(){
    // GET RIDES
    $.getJSON("http://localhost:8080/list/rides", function(result){
        $.each(result, function(i, field){
            var newElement = '<button type="button" class="rideButton col-md-12" id="'
            + field + '" > Ride ' + (i+1) + ' </button>';
            $(".button-row").append(newElement);
            console.log(newElement);
        });

    });
});

$(document).one("click", ".rideButton", function() {
    times = [];
    values = [];

    var fullData;

    var newTitle = '<div class="rideTitle"><h1>Ride ' + this.id[this.id.length - 1] + ' on 3/30/17 </h1></div>';

    $(".title").append(newTitle);

    $.getJSON('http://localhost:8080/data/' + this.id + '/Sensor.speedometer', function(result) {
        fullData = result;
        console.log(result);
        $.each(result, function(i, obj) {
            dump.push(obj);
            times.unshift(obj.time);
            values.push(obj.value);

            // if (i == 0 || i == 19) {
            //   obj.value = 0;
            // } else {
            //   obj.value = Math.floor(Math.random() * 24);
            // }


        });

        plotSVG(fullData);
        console.log(fullData);
    });

    $.getJSON("http://localhost:8080/stats/" + this.id + "/", function(result){
	data = result;

  $("#totalDistance").text("Total Distance Travelled:");
  $("#averageSpeed").text("Average Speed:");
  $("#emissionsPrevented").text("CO2 Emissions Avoided:");
  $("#totalDuration").text("Duration of Ride:");
	$(".averageSpeed").text(data.speed.average + " mph");
	$(".totalDistance").text(data.distance.traveled + " mi");
	$(".emissionsPrevented").text(data.carbon.emissionsPrevented + " ppm");
	$(".totalDuration").text(data.time.elapsed + " minutes");
    });

    //var myChart = graph(times, values);


    //console.log(max);
});



//Chart code



function graph(time, value) {
    $(".title").append('<canvas id="myChart" style="width: 100%;"></canvas>');

    var ctx = $("#myChart");

    var myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: time,
        datasets: [{
          label: 'Key',
          data: value,
          pointRadius: 1,
          pointHoverRadius: 10
        }],
      },
      options: {
        scales: {
            xAxes: [{
                display: true,
                scaleLabel: {
                  display: true,
                  labelString: 'TIME (s)'
                }
            }],
            yAxes: [{
                display: true,
                scaleLabel: {
                  display: true,
                  labelString: 'SPEED (mph)'
                }
            }]
        },
        title:{
                  display: true,
                  text:"Values"
              }
      }
    });

    return myChart;
}
</script>
</body>
